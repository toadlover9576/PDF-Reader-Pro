<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="E7knuFVZA_dGkubXqO4pMzNhFaQk7aSImN985b-rjGs" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Continua | PDF Reader Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid white;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .breadcrumb {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: #667eea;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .library-content {
            padding: 20px;
        }

        .library-item, .folder-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
            user-select: none;
            position: relative;
        }

        .library-item:hover, .folder-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }

        .library-item.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .library-item.dragging, .folder-item.dragging {
            opacity: 0.6;
            box-shadow: 0 0 0 2px #764ba2;
        }

        .library-item.drag-over, .folder-item.drag-over {
            border-color: #764ba2;
            box-shadow: 0 0 0 2px #667eea;
        }

        .folder-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-icon {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            width: 20px;
        }

        .folder-title {
            flex: 1;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .folder-count {
            font-size: 11px;
            color: #6c757d;
        }

        .folder-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .folder-item:hover .folder-actions {
            opacity: 1;
        }

        .folder-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .folder-btn:hover {
            background: rgba(102,126,234,0.1);
            color: #667eea;
        }

        .library-item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .library-item-progress {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .toc-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toc-item:hover {
            background: #e9ecef;
        }

        .viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #525659;
        }

        .toolbar {
            background: #2c3034;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-btn {
            background: #3c4044;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #4c5054;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-input {
            width: 60px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #5c6064;
            background: #3c4044;
            color: white;
            text-align: center;
        }

        .pdf-viewer {
            flex: 1;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .pdf-canvas-container {
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Continua | PDF Reader PRO</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="openAddModal()">+ Add PDF</button>
                <button class="btn btn-secondary" onclick="openAddFolderModal()">+ New Folder</button>
                <button class="btn btn-secondary" onclick="toggleSidebar()">Menu</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-tabs">
                    <div class="tab active" onclick="switchTab('library')">Library</div>
                    <div class="tab" onclick="switchTab('toc')">Contents</div>
                </div>
                <div class="tab-content" id="libraryTab">
                    <div class="breadcrumb" id="breadcrumb"></div>
                    <div class="library-content" id="libraryList"></div>
                </div>
                <div class="tab-content" id="tocTab" style="display: none;">
                    <div style="padding: 20px;" id="tocList"></div>
                </div>
            </div>

            <div class="viewer-container">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" onclick="prevPage()" id="prevBtn">Previous</button>
                        <div class="page-info">
                            <input type="number" class="page-input" id="pageInput" value="1" min="1" onchange="goToPage()">
                            <span>/ <span id="totalPages">0</span></span>
                        </div>
                        <button class="toolbar-btn" onclick="nextPage()" id="nextBtn">Next</button>
                    </div>
                    <div class="toolbar-right">
                        <div class="zoom-control">
                            <button class="toolbar-btn" onclick="zoomOut()">-</button>
                            <span id="zoomLevel">100%</span>
                            <button class="toolbar-btn" onclick="zoomIn()">+</button>
                        </div>
                        <button class="toolbar-btn" onclick="toggleFullscreen()" id="fullscreenBtn">Fullscreen</button>
                    </div>
                </div>
                <div class="pdf-viewer" id="pdfViewer">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <h3>No PDF Loaded</h3>
                        <p>Click "Add PDF" to load a document from URL</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addModal" onclick="if(event.target === this) closeAddModal()">
        <div class="modal-content">
            <div class="modal-header">
                Add PDF Document
                <button style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;" onclick="closeAddModal()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label">Document Name</label>
                <input type="text" class="form-input" id="pdfName" placeholder="Enter document name">
            </div>
            <div class="form-group">
                <label class="form-label">PDF URL</label>
                <input type="text" class="form-input" id="pdfUrl" placeholder="https://example.com/document.pdf">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addPdf()">Add to Library</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addFolderModal" onclick="if(event.target === this) closeAddFolderModal()">
        <div class="modal-content">
            <div class="modal-header">
                New Folder
                <button style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;" onclick="closeAddFolderModal()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label">Folder Name</label>
                <input type="text" class="form-input" id="folderName" placeholder="Enter folder name">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddFolderModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addFolder()">Create Folder</button>
            </div>
        </div>
    </div>

    <div class="modal" id="renameFolderModal" onclick="if(event.target === this) closeRenameFolderModal()">
        <div class="modal-content">
            <div class="modal-header">
                Rename Folder
                <button style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;" onclick="closeRenameFolderModal()">×</button>
            </div>
            <div class="form-group">
                <label class="form-label">Folder Name</label>
                <input type="text" class="form-input" id="renameFolderName" placeholder="Enter new folder name">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRenameFolderModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRenameFolder()">Rename</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let library = JSON.parse(localStorage.getItem('pdfLibrary') || '[]');
        let folders = JSON.parse(localStorage.getItem('pdfFolders') || '[]');
        let currentFolderId = null;
        let currentPdf = null;
        let currentPage = 1;
        let totalPages = 0;
        let scale = 1.5;
        let pdfDoc = null;
        let currentPdfId = null;
        let renamingFolderId = null;

        let dragStartItem = null;
        let isDragging = false;

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round((scale / 1.5) * 100) + '%';
        }

        function renderLibrary() {
            const list = document.getElementById('libraryList');
            const breadcrumb = document.getElementById('breadcrumb');
            
            const path = getFolderPath(currentFolderId);
            breadcrumb.innerHTML = path.map((folder, idx) => {
                const isLast = idx === path.length - 1;
                return `
                    <span class="breadcrumb-item" onclick="navigateToFolder('${folder.id || 'root'}')">${folder.name}</span>
                    ${!isLast ? '<span>></span>' : ''}
                `;
            }).join('');
            
            const currentFolders = folders.filter(f => (f.parentId || 'root') === (currentFolderId || 'root'));
            const currentPdfs = library.filter(p => (p.folderId || 'root') === (currentFolderId || 'root'));
            
            if (currentFolders.length === 0 && currentPdfs.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>This folder is empty</p></div>';
                return;
            }
            
            let html = '';
            
            currentFolders.forEach((folder) => {
                const itemCount = countItemsInFolder(folder.id);
                html += `
                    <div class="folder-item" data-folder-id="${folder.id}" data-item-type="folder">
                        <div class="folder-header">
                            <span class="folder-icon">▶</span>
                            <span class="folder-title" ondblclick="navigateToFolder('${folder.id}')">${folder.name}</span>
                            <span class="folder-count">(${itemCount})</span>
                            <div class="folder-actions">
                                <button class="folder-btn" onclick="event.stopPropagation(); openRenameFolder('${folder.id}')">Edit</button>
                                <button class="folder-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            currentPdfs.forEach((item) => {
                html += `
                    <div class="library-item ${currentPdfId === item.id ? 'active' : ''}"
                         data-pdf-id="${item.id}" data-item-type="pdf">
                        <div onclick="loadPdfFromLibrary('${item.id}')">
                            <div class="library-item-title">${item.name}</div>
                            <div class="library-item-progress">Page ${item.currentPage} of ${item.totalPages}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(item.currentPage / item.totalPages * 100)}%"></div>
                            </div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deletePdf('${item.id}')">Delete</button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            attachDragHandlers();
        }

        function countItemsInFolder(folderId) {
            let count = library.filter(p => p.folderId === folderId).length;
            const subfolders = folders.filter(f => f.parentId === folderId);
            subfolders.forEach(sf => {
                count += countItemsInFolder(sf.id);
            });
            return count;
        }

        function getFolderPath(folderId) {
            const path = [{ id: null, name: 'Library' }];
            let currentId = folderId;
            
            while (currentId) {
                const folder = folders.find(f => f.id === currentId);
                if (folder) {
                    path.splice(1, 0, folder);
                    currentId = folder.parentId;
                } else {
                    break;
                }
            }
            
            return path;
        }

        function navigateToFolder(folderId) {
            currentFolderId = folderId === 'root' ? null : folderId;
            renderLibrary();
        }

        function attachDragHandlers() {
            const items = document.querySelectorAll('.library-item, .folder-item');
            items.forEach(item => {
                item.onmousedown = function(e) {
                    if (e.button !== 0 || e.target.tagName === 'BUTTON' || e.target.classList.contains('folder-btn')) return;

                    isDragging = true;
                    dragStartItem = {
                        element: this,
                        type: this.getAttribute('data-item-type'),
                        id: this.getAttribute('data-item-type') === 'folder' ? 
                            this.getAttribute('data-folder-id') : 
                            this.getAttribute('data-pdf-id')
                    };
                    this.classList.add('dragging');

                    function onMouseMove(ev) {
                        if (!isDragging) return;
                        const el = document.elementFromPoint(ev.clientX, ev.clientY);
                        if (!el) return;
                        
                        document.querySelectorAll('.drag-over').forEach(i => i.classList.remove('drag-over'));
                        
                        const targetFolder = el.closest('.folder-item');
                        if (targetFolder && targetFolder !== dragStartItem.element) {
                            targetFolder.classList.add('drag-over');
                        }
                    }

                    function onMouseUp(ev) {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);

                        if (!isDragging) return;
                        isDragging = false;

                        dragStartItem.element.classList.remove('dragging');
                        document.querySelectorAll('.drag-over').forEach(i => i.classList.remove('drag-over'));

                        const el = document.elementFromPoint(ev.clientX, ev.clientY);
                        if (el) {
                            const targetFolder = el.closest('.folder-item');
                            if (targetFolder && targetFolder !== dragStartItem.element) {
                                const targetFolderId = targetFolder.getAttribute('data-folder-id');
                                moveItemToFolder(dragStartItem.type, dragStartItem.id, targetFolderId);
                            }
                        }

                        dragStartItem = null;
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            });
        }

        function moveItemToFolder(itemType, itemId, targetFolderId) {
            if (itemType === 'pdf') {
                const pdf = library.find(p => p.id === itemId);
                if (pdf) {
                    pdf.folderId = targetFolderId;
                    localStorage.setItem('pdfLibrary', JSON.stringify(library));
                }
            } else if (itemType === 'folder') {
                if (!isDescendantFolder(targetFolderId, itemId)) {
                    const folder = folders.find(f => f.id === itemId);
                    if (folder) {
                        folder.parentId = targetFolderId;
                        localStorage.setItem('pdfFolders', JSON.stringify(folders));
                    }
                }
            }
            renderLibrary();
        }

        function isDescendantFolder(checkId, ancestorId) {
            let currentId = checkId;
            while (currentId) {
                if (currentId === ancestorId) return true;
                const folder = folders.find(f => f.id === currentId);
                currentId = folder ? folder.parentId : null;
            }
            return false;
        }

        function openAddFolderModal() {
            document.getElementById('addFolderModal').classList.add('active');
            document.getElementById('folderName').value = '';
        }

        function closeAddFolderModal() {
            document.getElementById('addFolderModal').classList.remove('active');
        }

        function addFolder() {
            const name = document.getElementById('folderName').value.trim();
            
            if (!name) {
                alert('Please enter a folder name');
                return;
            }

            const folder = {
                id: 'folder_' + Date.now(),
                name: name,
                parentId: currentFolderId,
                createdDate: new Date().toISOString()
            };
            
            folders.push(folder);
            localStorage.setItem('pdfFolders', JSON.stringify(folders));
            renderLibrary();
            closeAddFolderModal();
        }

        function openRenameFolder(folderId) {
            renamingFolderId = folderId;
            const folder = folders.find(f => f.id === folderId);
            if (folder) {
                document.getElementById('renameFolderName').value = folder.name;
                document.getElementById('renameFolderModal').classList.add('active');
            }
        }

        function closeRenameFolderModal() {
            document.getElementById('renameFolderModal').classList.remove('active');
            renamingFolderId = null;
        }

        function confirmRenameFolder() {
            const newName = document.getElementById('renameFolderName').value.trim();
            
            if (!newName) {
                alert('Please enter a folder name');
                return;
            }

            const folder = folders.find(f => f.id === renamingFolderId);
            if (folder) {
                folder.name = newName;
                localStorage.setItem('pdfFolders', JSON.stringify(folders));
                renderLibrary();
            }
            
            closeRenameFolderModal();
        }

        function deleteFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            
            const itemCount = library.filter(p => p.folderId === folderId).length;
            const subfolderCount = folders.filter(f => f.parentId === folderId).length;
            
            let message = `Are you sure you want to delete "${folder.name}"?`;
            if (itemCount > 0 || subfolderCount > 0) {
                message += `\n\nThis folder contains ${itemCount} PDF(s) and ${subfolderCount} subfolder(s). All items will be moved to the parent folder.`;
            }
            
            if (confirm(message)) {
                library.forEach(pdf => {
                    if (pdf.folderId === folderId) {
                        pdf.folderId = folder.parentId;
                    }
                });
                
                folders.forEach(f => {
                    if (f.parentId === folderId) {
                        f.parentId = folder.parentId;
                    }
                });
                
                const folderIndex = folders.findIndex(f => f.id === folderId);
                folders.splice(folderIndex, 1);
                
                localStorage.setItem('pdfLibrary', JSON.stringify(library));
                localStorage.setItem('pdfFolders', JSON.stringify(folders));
                renderLibrary();
            }
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            document.getElementById('pdfName').value = '';
            document.getElementById('pdfUrl').value = '';
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        async function addPdf() {
            const name = document.getElementById('pdfName').value.trim();
            const url = document.getElementById('pdfUrl').value.trim();
            
            if (!name || !url) {
                alert('Please enter both name and URL');
                return;
            }

            const addButton = event.target;
            const originalText = addButton.textContent;
            addButton.textContent = 'Loading...';
            addButton.disabled = true;

            try {
                const proxies = [
                    url,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
                ];

                let pdf = null;
                let lastError = null;

                for (const proxyUrl of proxies) {
                    try {
                        const loadingTask = pdfjsLib.getDocument({
                            url: proxyUrl,
                            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                            cMapPacked: true,
                            withCredentials: false
                        });
                        
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Loading timeout')), 10000)
                        );
                        
                        pdf = await Promise.race([loadingTask.promise, timeoutPromise]);
                        break;
                    } catch (err) {
                        lastError = err;
                        console.warn(`Failed with proxy: ${proxyUrl}`, err);
                        continue;
                    }
                }

                if (!pdf) {
                    throw lastError || new Error('All loading methods failed');
                }
                
                const pdfItem = {
                    id: Date.now(),
                    name: name,
                    url: url,
                    currentPage: 1,
                    totalPages: pdf.numPages,
                    scale: 1.5,
                    folderId: currentFolderId,
                    addedDate: new Date().toISOString()
                };
                
                library.push(pdfItem);
                localStorage.setItem('pdfLibrary', JSON.stringify(library));
                renderLibrary();
                closeAddModal();
                await loadPdfFromLibrary(pdfItem.id);
            } catch (error) {
                alert('Failed to load PDF. The URL might be invalid or the PDF might be protected. Error: ' + error.message);
                console.error(error);
            } finally {
                addButton.textContent = originalText;
                addButton.disabled = false;
            }
        }

        function deletePdf(pdfId) {
            if (confirm('Are you sure you want to delete this PDF from your library?')) {
                const index = library.findIndex(p => p.id === pdfId);
                if (index !== -1) {
                    library.splice(index, 1);
                    localStorage.setItem('pdfLibrary', JSON.stringify(library));
                    renderLibrary();
                    if (library.length === 0) {
                        document.getElementById('pdfViewer').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"></div>
                                <h3>No PDF Loaded</h3>
                                <p>Click "Add PDF" to load a document from URL</p>
                            </div>
                        `;
                    }
                }
            }
        }

        async function loadPdfFromLibrary(pdfId) {
            const item = library.find(p => p.id === pdfId);
            if (!item) return;
            
            currentPdfId = item.id;
            
            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>Loading PDF...</h3></div>';
            
            try {
                const proxies = [
                    item.url,
                    `https://corsproxy.io/?${encodeURIComponent(item.url)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(item.url)}`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(item.url)}`
                ];

                let pdf = null;
                let lastError = null;

                for (const proxyUrl of proxies) {
                    try {
                        const loadingTask = pdfjsLib.getDocument({
                            url: proxyUrl,
                            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                            cMapPacked: true,
                            withCredentials: false
                        });
                        
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Loading timeout')), 10000)
                        );
                        
                        pdf = await Promise.race([loadingTask.promise, timeoutPromise]);
                        break;
                    } catch (err) {
                        lastError = err;
                        console.warn(`Failed to load with: ${proxyUrl}`, err);
                        continue;
                    }
                }

                if (!pdf) {
                    throw lastError || new Error('Failed to load PDF from all sources');
                }

                pdfDoc = pdf;
                totalPages = pdfDoc.numPages;
                currentPage = item.currentPage;
                scale = item.scale || 1.5;
                
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('pageInput').max = totalPages;
                updateZoomDisplay();
                
                await renderPage(currentPage);
                await loadTableOfContents();
                renderLibrary();
                updateProgress();
            } catch (error) {
                viewer.innerHTML = `<div class="empty-state"><div class="empty-state-icon">Error</div><h3>Failed to Load PDF</h3><p>${error.message}</p></div>`;
                console.error(error);
            }
        }

        async function renderPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            const viewer = document.getElementById('pdfViewer');
            viewer.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'pdf-canvas-container';
            container.appendChild(canvas);
            viewer.appendChild(container);
            
            document.getElementById('pageInput').value = pageNum;
            currentPage = pageNum;
            
            updateProgress();
        }

        function updateProgress() {
            if (currentPdfId) {
                const item = library.find(p => p.id === currentPdfId);
                if (item) {
                    item.currentPage = currentPage;
                    item.scale = scale;
                    localStorage.setItem('pdfLibrary', JSON.stringify(library));
                    renderLibrary();
                }
            }
        }

        async function loadTableOfContents() {
            const outline = await pdfDoc.getOutline();
            const tocList = document.getElementById('tocList');
            
            if (!outline || outline.length === 0) {
                tocList.innerHTML = '<div class="empty-state"><p>No table of contents available</p></div>';
                return;
            }
            
            function renderOutline(items, level = 0) {
                return items.map(item => {
                    const pageNum = item.dest ? (Array.isArray(item.dest) ? item.dest[0] : null) : null;
                    return `
                        <div class="toc-item" style="padding-left: ${level * 20 + 10}px" onclick="goToTocPage('${item.dest}')">
                            ${item.title}
                        </div>
                        ${item.items ? renderOutline(item.items, level + 1) : ''}
                    `;
                }).join('');
            }
            
            tocList.innerHTML = renderOutline(outline);
        }

        async function goToTocPage(dest) {
            if (!dest) return;
            try {
                const destArray = await pdfDoc.getDestination(dest);
                if (destArray) {
                    const pageIndex = await pdfDoc.getPageIndex(destArray[0]);
                    await renderPage(pageIndex + 1);
                }
            } catch (error) {
                console.error('Error navigating to TOC item:', error);
            }
        }

        async function nextPage() {
            if (currentPage < totalPages) {
                await renderPage(currentPage + 1);
            }
        }

        async function prevPage() {
            if (currentPage > 1) {
                await renderPage(currentPage - 1);
            }
        }

        async function goToPage() {
            const pageNum = parseInt(document.getElementById('pageInput').value);
            if (pageNum >= 1 && pageNum <= totalPages) {
                await renderPage(pageNum);
            }
        }

        async function zoomIn() {
            scale += 0.25;
            updateZoomDisplay();
            if (pdfDoc) {
                await renderPage(currentPage);
                updateProgress();
            }
        }

        async function zoomOut() {
            if (scale > 0.5) {
                scale -= 0.25;
                updateZoomDisplay();
                if (pdfDoc) {
                    await renderPage(currentPage);
                    updateProgress();
                }
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            
            if (tab === 'library') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('libraryTab').style.display = 'block';
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('tocTab').style.display = 'block';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
        }

        function toggleFullscreen() {
            const container = document.querySelector('.container');
            const btn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().then(() => {
                    btn.textContent = 'Exit Fullscreen';
                }).catch(err => {
                    alert('Error attempting to enable fullscreen: ' + err.message);
                });
            } else {
                document.exitFullscreen().then(() => {
                    btn.textContent = 'Fullscreen';
                });
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            if (!document.fullscreenElement) {
                btn.textContent = 'Fullscreen';
            }
        });

        renderLibrary();
    </script>
</body>
</html>
