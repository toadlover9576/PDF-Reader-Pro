<!DOCTYPE html>
<html lang="en">
<head>
<meta name="google-site-verification" content="E7knuFVZA_dGkubXqO4pMzNhFaQk7aSImN985b-rjGs" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Continua | PDF Reader Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 40px);
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    font-size: 28px;
    font-weight: 600;
}

.header-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-primary {
    background: white;
    color: #667eea;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-secondary {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid white;
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.3);
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.sidebar {
    width: 300px;
    background: #f8f9fa;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-tabs {
    display: flex;
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
}

.tab {
    flex: 1;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
}

.tab.active {
    color: #667eea;
    background: white;
    border-bottom-color: #667eea;
}

.tab-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.library-item {
    background: white;
    padding: 12px 10px;
    margin-bottom: 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid #e0e0e0;
    user-select: none;
    position: relative;
    display: flex;
    gap: 8px;
}

.library-item:hover {
    border-color: #667eea;
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.2);
}

.library-item.active {
    border-color: #667eea;
    background: #f0f4ff;
}

.library-item-main {
    flex: 1;
}

.library-item-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    font-size: 14px;
}

.library-item-progress {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 8px;
}

.progress-bar {
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s;
}

.library-item-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
}

.book-menu-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px 4px;
}

.book-menu-btn:hover {
    color: #667eea;
}

.book-menu-dropdown {
    position: absolute;
    right: 10px;
    top: 30px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 180px;
    z-index: 100;
    display: none;
}

.book-menu-dropdown.open {
    display: block;
}

.book-menu-item {
    padding: 8px 10px;
    font-size: 13px;
    cursor: pointer;
}

.book-menu-item:hover {
    background: #f1f3f5;
}

.book-menu-item.disabled {
    color: #adb5bd;
    cursor: default;
}

.toc-item {
    padding: 10px;
    cursor: pointer;
    border-radius: 5px;
    margin-bottom: 5px;
    transition: all 0.2s;
    font-size: 14px;
}

.toc-item:hover {
    background: #e9ecef;
}

.viewer-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #525659;
}

.toolbar {
    background: #2c3034;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}

.toolbar-left, .toolbar-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

.toolbar-btn {
    background: #3c4044;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.toolbar-btn:hover {
    background: #4c5054;
}

.toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.page-input {
    width: 60px;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #5c6064;
    background: #3c4044;
    color: white;
    text-align: center;
}

.pdf-viewer {
    flex: 1;
    overflow-y: auto;
    display: flex;
    justify-content: center;
    padding: 20px;
}

.pdf-canvas-container {
    background: white;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
}

.form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.zoom-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.delete-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    margin-top: 5px;
}

.delete-btn:hover {
    background: #c82333;
}

.folder-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
}

.folder-select {
    flex: 1 1 120px;
    min-width: 120px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #ced4da;
    font-size: 12px;
    background: #ffffff;
}

.folder-pill {
    flex: 0 0 auto;
    padding: 4px 8px;
    border-radius: 999px;
    background: #e9ecef;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.folder-pill:hover {
    background: #dee2e6;
}

#folderPalette {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 10px;
}

::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1> Continua | PDF Reader PRO</h1>
<div class="header-buttons">
<button class="btn btn-primary" onclick="openAddModal()">+ Add PDF</button>
<button class="btn btn-secondary" onclick="toggleSidebar()">‚ò∞ Menu</button>
</div>
</div>

<div class="main-content">
<div class="sidebar" id="sidebar">
<div class="sidebar-tabs">
<div class="tab active" onclick="switchTab('library')">Library</div>
<div class="tab" onclick="switchTab('toc')">Contents</div>
</div>
<div class="tab-content" id="libraryTab">
    <div class="folder-bar">
        <select id="folderSelect" class="folder-select" onchange="changeFolder()"></select>
        <button class="folder-pill" onclick="addFolder()">+F</button>
        <button class="folder-pill" onclick="renameFolder()">‚úé</button>
        <button class="folder-pill" onclick="deleteFolder()">üóë</button>
    </div>
    <div id="folderPalette"></div>
    <div id="libraryList"></div>
</div>
<div class="tab-content" id="tocTab" style="display: none;">
<div id="tocList"></div>
</div>
</div>

<div class="viewer-container">
<div class="toolbar">
<div class="toolbar-left">
<button class="toolbar-btn" onclick="prevPage()" id="prevBtn">‚Üê Previous</button>
<div class="page-info">
<input type="number" class="page-input" id="pageInput" value="1" min="1" onchange="goToPage()">
<span>/ <span id="totalPages">0</span></span>
</div>
<button class="toolbar-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
</div>
<div class="toolbar-right">
<div class="zoom-control">
<button class="toolbar-btn" onclick="zoomOut()">-</button>
<span id="zoomLevel">100%</span>
<button class="toolbar-btn" onclick="zoomIn()">+</button>
</div>
<button class="toolbar-btn" onclick="toggleFullscreen()" id="fullscreenBtn">‚õ∂ Fullscreen</button>
</div>
</div>
<div class="pdf-viewer" id="pdfViewer">
<div class="empty-state">
<div class="empty-state-icon"></div>
<h3>No PDF Loaded</h3>
<p>Click "Add PDF" to load a document from URL</p>
</div>
</div>
</div>
</div>
</div>

<div class="modal" id="addModal" onclick="if(event.target === this) closeAddModal()">
<div class="modal-content">
<div class="modal-header">
Add PDF Document
<button style="float: right; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;" onclick="closeAddModal()">√ó</button>
</div>
<div class="form-group">
<label class="form-label">Document Name</label>
<input type="text" class="form-input" id="pdfName" placeholder="Enter document name">
</div>
<div class="form-group">
<label class="form-label">PDF URL</label>
<input type="text" class="form-input" id="pdfUrl" placeholder="https://example.com/document.pdf">
</div>
<div class="modal-buttons">
<button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
<button class="btn btn-primary" onclick="addPdf()">Add to Library</button>
</div>
</div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let library = JSON.parse(localStorage.getItem('pdfLibrary') || '[]');
let currentPdf = null;
let currentPage = 1;
let totalPages = 0;
let scale = 1.5;
let pdfDoc = null;
let currentPdfId = null;

let folders = JSON.parse(localStorage.getItem('pdfFolders') || '[]');
let activeFolder = localStorage.getItem('pdfActiveFolder') || 'All';

if (Array.isArray(folders) && typeof folders[0] === 'string') {
    folders = folders.map(name => ({
        id: 'fld_' + name,
        name,
        color: '#e9ecef',
        icon: 'üìÅ'
    }));
}

if (!folders.length) {
    folders = [{
        id: 'fld_All',
        name: 'All',
        color: '#e9ecef',
        icon: 'üìÅ'
    }];
    activeFolder = 'All';
}
if (!activeFolder) activeFolder = 'All';

library.forEach(b => {
    if (!Array.isArray(b.folders)) {
        if (b.folder) {
            b.folders = [b.folder];
            delete b.folder;
        } else {
            b.folders = ['All'];
        }
    }
    if (!b.folders.includes('All')) {
        b.folders.push('All');
    }
});

localStorage.setItem('pdfLibrary', JSON.stringify(library));
localStorage.setItem('pdfFolders', JSON.stringify(folders));
localStorage.setItem('pdfActiveFolder', activeFolder);

function saveFolders() {
    localStorage.setItem('pdfFolders', JSON.stringify(folders));
    localStorage.setItem('pdfActiveFolder', activeFolder);
}

function renderFolderSelect() {
    const select = document.getElementById('folderSelect');
    const palette = document.getElementById('folderPalette');

    if (!folders.find(f => f.name === 'All')) {
        folders.unshift({
            id: 'fld_All',
            name: 'All',
            color: '#e9ecef',
            icon: 'üìÅ'
        });
    }

    if (select) {
        select.innerHTML = folders.map(f => `
            <option value="${f.name}" ${f.name === activeFolder ? 'selected' : ''}>
                ${f.icon || 'üìÅ'} ${f.name}
            </option>
        `).join('');
    }

    if (palette) {
        palette.innerHTML = folders.map(f => `
            <div class="folder-pill" data-folder="${f.name}">
                ${f.icon || 'üìÅ'} ${f.name}
            </div>
        `).join('');
    }
}

function changeFolder() {
    const select = document.getElementById('folderSelect');
    activeFolder = select.value;
    saveFolders();
    renderLibrary();
}

function addFolder() {
    const name = prompt('New folder name:');
    if (!name) return;
    const trimmed = name.trim();
    if (!trimmed) return;
    if (folders.find(f => f.name === trimmed)) return;

    folders.push({
        id: 'fld_' + Date.now(),
        name: trimmed,
        color: '#e9ecef',
        icon: 'üìÅ'
    });
    activeFolder = trimmed;
    saveFolders();
    renderFolderSelect();
    renderLibrary();
}

function renameFolder() {
    if (activeFolder === 'All') {
        alert('You cannot rename the "All" folder.');
        return;
    }
    const folder = folders.find(f => f.name === activeFolder);
    if (!folder) return;

    const newName = prompt('Rename folder:', folder.name);
    if (!newName) return;
    const trimmed = newName.trim();
    if (!trimmed) return;

    folder.name = trimmed;
    library.forEach(b => {
        if (b.folders.includes(activeFolder)) {
            const idx = b.folders.indexOf(activeFolder);
            b.folders[idx] = trimmed;
        }
    });

    activeFolder = trimmed;
    localStorage.setItem('pdfLibrary', JSON.stringify(library));
    saveFolders();
    renderFolderSelect();
    renderLibrary();
}

function deleteFolder() {
    if (activeFolder === 'All') {
        alert('You cannot delete the "All" folder.');
        return;
    }
    if (!confirm(`Delete folder "${activeFolder}"? Books will remain in All.`)) return;

    folders = folders.filter(f => f.name !== activeFolder);
    library.forEach(b => {
        b.folders = b.folders.filter(fn => fn !== activeFolder);
        if (!b.folders.length) b.folders.push('All');
    });

    activeFolder = 'All';
    localStorage.setItem('pdfLibrary', JSON.stringify(library));
    saveFolders();
    renderFolderSelect();
    renderLibrary();
}

function toggleBookMenu(event, index) {
    event.stopPropagation();
    closeAllBookMenus();
    const item = document.querySelector(`.library-item[data-index="${index}"]`);
    if (!item) return;
    const menu = item.querySelector('.book-menu-dropdown');
    if (!menu) return;
    menu.classList.toggle('open');
}

function closeAllBookMenus() {
    document.querySelectorAll('.book-menu-dropdown.open').forEach(m => m.classList.remove('open'));
}

function addBookToFolder(index) {
    const book = library[index];
    if (!book) return;

    const folderNames = folders.map(f => f.name);
    const input = prompt(
        `Add "${book.name}" to which folder?\n\nExisting folders:\n- ` +
        folderNames.join('\n- ')
    );
    if (!input) {
        closeAllBookMenus();
        return;
    }
    const trimmed = input.trim();
    if (!trimmed) {
        closeAllBookMenus();
        return;
    }

    let folder = folders.find(f => f.name === trimmed);
    if (!folder) {
        folder = {
            id: 'fld_' + Date.now(),
            name: trimmed,
            color: '#e9ecef',
            icon: 'üìÅ'
        };
        folders.push(folder);
        saveFolders();
        renderFolderSelect();
    }

    if (!Array.isArray(book.folders)) {
        book.folders = ['All'];
    }
    if (!book.folders.includes(trimmed)) {
        book.folders.push(trimmed);
    }
    if (!book.folders.includes('All')) {
        book.folders.push('All');
    }

    localStorage.setItem('pdfLibrary', JSON.stringify(library));
    renderLibrary();
    closeAllBookMenus();
    alert(`"${book.name}" added to folder "${trimmed}".`);
}

function removeBookFromCurrentFolder(index) {
    if (activeFolder === 'All') {
        closeAllBookMenus();
        return;
    }
    const book = library[index];
    if (!book || !Array.isArray(book.folders)) {
        closeAllBookMenus();
        return;
    }
    if (!book.folders.includes(activeFolder)) {
        closeAllBookMenus();
        return;
    }

    book.folders = book.folders.filter(fn => fn !== activeFolder);
    if (!book.folders.length) {
        book.folders.push('All');
    }
    if (!book.folders.includes('All')) {
        book.folders.push('All');
    }

    localStorage.setItem('pdfLibrary', JSON.stringify(library));
    renderLibrary();
    closeAllBookMenus();
    alert(`"${book.name}" removed from folder "${activeFolder}".`);
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.library-item-right')) {
        closeAllBookMenus();
    }
});

function renderLibrary() {
    const list = document.getElementById('libraryList');
    if (!list) return;

    let visibleItems;
    if (activeFolder === 'All') {
        visibleItems = library;
    } else {
        visibleItems = library.filter(item =>
            Array.isArray(item.folders) && item.folders.includes(activeFolder)
        );
    }

    if (visibleItems.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><p>No books in this folder</p></div>';
        return;
    }

    list.innerHTML = visibleItems.map((item) => {
        const realIndex = library.findIndex(b => b.id === item.id);
        const canRemoveFromFolder = activeFolder !== 'All' &&
            Array.isArray(item.folders) &&
            item.folders.includes(activeFolder);
        return `
        <div class="library-item ${currentPdfId === item.id ? 'active' : ''}"
             data-index="${realIndex}">
            <div class="library-item-main" onclick="loadPdfFromLibrary(${realIndex})">
                <div class="library-item-title">${item.name}</div>
                <div class="library-item-progress">Page ${item.currentPage} of ${item.totalPages}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${(item.currentPage / item.totalPages * 100)}%"></div>
                </div>
            </div>
            <div class="library-item-right">
                <button class="book-menu-btn" onclick="toggleBookMenu(event, ${realIndex})">‚ãÆ</button>
                <button class="delete-btn" onclick="event.stopPropagation(); deletePdf(${realIndex})">Delete</button>
                <div class="book-menu-dropdown">
                    <div class="book-menu-item" onclick="addBookToFolder(${realIndex})">
                        Add to folder
                    </div>
                    <div class="book-menu-item ${canRemoveFromFolder ? '' : 'disabled'}"
                         onclick="${canRemoveFromFolder ? `removeBookFromCurrentFolder(${realIndex})` : 'event.stopPropagation();'}">
                        Remove from this folder
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function openAddModal() {
    document.getElementById('addModal').classList.add('active');
    document.getElementById('pdfName').value = '';
    document.getElementById('pdfUrl').value = '';
}

function closeAddModal() {
    document.getElementById('addModal').classList.remove('active');
}

async function addPdf() {
    const name = document.getElementById('pdfName').value.trim();
    const url = document.getElementById('pdfUrl').value.trim();

    if (!name || !url) {
        alert('Please enter both name and URL');
        return;
    }

    const addButton = event.target;
    const originalText = addButton.textContent;
    addButton.textContent = 'Loading...';
    addButton.disabled = true;

    try {
        const proxies = [
            url,
            `https://corsproxy.io/?${encodeURIComponent(url)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
        ];

        let pdf = null;
        let lastError = null;

        for (const proxyUrl of proxies) {
            try {
                const loadingTask = pdfjsLib.getDocument({
                    url: proxyUrl,
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                    cMapPacked: true,
                    withCredentials: false
                });

                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Loading timeout')), 10000)
                );

                pdf = await Promise.race([loadingTask.promise, timeoutPromise]);
                break;
            } catch (err) {
                lastError = err;
                console.warn(`Failed with proxy: ${proxyUrl}`, err);
                continue;
            }
        }

        if (!pdf) {
            throw lastError || new Error('All loading methods failed');
        }

        const pdfItem = {
            id: Date.now(),
            name: name,
            url: url,
            currentPage: 1,
            totalPages: pdf.numPages,
            scale: 1.5,
            folders: [activeFolder || 'All'],
            addedDate: new Date().toISOString()
        };

        if (!pdfItem.folders.includes('All')) pdfItem.folders.push('All');

        library.push(pdfItem);
        localStorage.setItem('pdfLibrary', JSON.stringify(library));
        renderLibrary();
        closeAddModal();
        await loadPdfFromLibrary(library.length - 1);
    } catch (error) {
        alert('Failed to load PDF. The URL might be invalid or the PDF might be protected. Error: ' + error.message);
        console.error(error);
    } finally {
        addButton.textContent = originalText;
        addButton.disabled = false;
    }
}

function deletePdf(index) {
    if (confirm('Are you sure you want to delete this PDF from your library?')) {
        library.splice(index, 1);
        localStorage.setItem('pdfLibrary', JSON.stringify(library));
        renderLibrary();
        if (library.length === 0) {
            document.getElementById('pdfViewer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <h3>No PDF Loaded</h3>
                    <p>Click "Add PDF" to load a document from URL</p>
                </div>
            `;
        }
    }
}

async function loadPdfFromLibrary(index) {
    const item = library[index];
    currentPdfId = item.id;

    const viewer = document.getElementById('pdfViewer');
    viewer.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>Loading PDF...</h3></div>';

    try {
        const proxies = [
            item.url,
            `https://corsproxy.io/?${encodeURIComponent(item.url)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(item.url)}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(item.url)}`
        ];

        let pdf = null;
        let lastError = null;

        for (const proxyUrl of proxies) {
            try {
                const loadingTask = pdfjsLib.getDocument({
                    url: proxyUrl,
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                    cMapPacked: true,
                    withCredentials: false
                });

                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Loading timeout')), 10000)
                );

                pdf = await Promise.race([loadingTask.promise, timeoutPromise]);
                break;
            } catch (err) {
                lastError = err;
                console.warn(`Failed to load with: ${proxyUrl}`, err);
                continue;
            }
        }

        if (!pdf) {
            throw lastError || new Error('Failed to load PDF from all sources');
        }

        pdfDoc = pdf;
        totalPages = pdfDoc.numPages;
        currentPage = item.currentPage;
        scale = item.scale || 1.5;

        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('pageInput').max = totalPages;
        updateZoomDisplay();

        await renderPage(currentPage);
        await loadTableOfContents();
        renderLibrary();
        updateProgress();
    } catch (error) {
        viewer.innerHTML = `<div class="empty-state"><div class="empty-state-icon"></div><h3>Failed to Load PDF</h3><p>${error.message}</p></div>`;
        console.error(error);
    }
}

async function renderPage(pageNum) {
    const page = await pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: scale });

    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const renderContext = {
        canvasContext: context,
        viewport: viewport
    };

    await page.render(renderContext).promise;

    const viewer = document.getElementById('pdfViewer');
    viewer.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'pdf-canvas-container';
    container.appendChild(canvas);
    viewer.appendChild(container);

    document.getElementById('pageInput').value = pageNum;
    currentPage = pageNum;

    updateProgress();
}

function updateProgress() {
    if (currentPdfId) {
        const index = library.findIndex(item => item.id === currentPdfId);
        if (index !== -1) {
            library[index].currentPage = currentPage;
            library[index].scale = scale;
            localStorage.setItem('pdfLibrary', JSON.stringify(library));
            renderLibrary();
        }
    }
}

async function loadTableOfContents() {
    const outline = await pdfDoc.getOutline();
    const tocList = document.getElementById('tocList');

    if (!outline || outline.length === 0) {
        tocList.innerHTML = '<div class="empty-state"><p>No table of contents available</p></div>';
        return;
    }

    function renderOutline(items, level = 0) {
        return items.map(item => {
            return `
                <div class="toc-item" style="padding-left: ${level * 20 + 10}px" onclick="goToTocPage('${item.dest}')">
                    ${item.title}
                </div>
                ${item.items ? renderOutline(item.items, level + 1) : ''}
            `;
        }).join('');
    }

    tocList.innerHTML = renderOutline(outline);
}

async function goToTocPage(dest) {
    if (!dest) return;
    try {
        const destArray = await pdfDoc.getDestination(dest);
        if (destArray) {
            const pageIndex = await pdfDoc.getPageIndex(destArray[0]);
            await renderPage(pageIndex + 1);
        }
    } catch (error) {
        console.error('Error navigating to TOC item:', error);
    }
}

async function nextPage() {
    if (currentPage < totalPages) {
        await renderPage(currentPage + 1);
    }
}

async function prevPage() {
    if (currentPage > 1) {
        await renderPage(currentPage - 1);
    }
}

async function goToPage() {
    const pageNum = parseInt(document.getElementById('pageInput').value);
    if (pageNum >= 1 && pageNum <= totalPages) {
        await renderPage(pageNum);
    }
}

async function zoomIn() {
    scale += 0.25;
    updateZoomDisplay();
    if (pdfDoc) {
        await renderPage(currentPage);
        updateProgress();
    }
}

async function zoomOut() {
    if (scale > 0.5) {
        scale -= 0.25;
        updateZoomDisplay();
        if (pdfDoc) {
            await renderPage(currentPage);
            updateProgress();
        }
    }
}

function updateZoomDisplay() {
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');

    if (tab === 'library') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('libraryTab').style.display = 'block';
    } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tocTab').style.display = 'block';
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
}

function toggleFullscreen() {
    const container = document.querySelector('.container');
    const btn = document.getElementById('fullscreenBtn');

    if (!document.fullscreenElement) {
        container.requestFullscreen().then(() => {
            btn.textContent = '‚õ∂ Exit Fullscreen';
        }).catch(err => {
            alert('Error attempting to enable fullscreen: ' + err.message);
        });
    } else {
        document.exitFullscreen().then(() => {
            btn.textContent = '‚õ∂ Fullscreen';
        });
    }
}

document.addEventListener('fullscreenchange', () => {
    const btn = document.getElementById('fullscreenBtn');
    if (!document.fullscreenElement) {
        btn.textContent = '‚õ∂ Fullscreen';
    }
});

renderFolderSelect();
renderLibrary();
updateZoomDisplay();
</script>
</body>
</html>

